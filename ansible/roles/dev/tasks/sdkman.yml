# SDKMan! to install different SDKs/JDKs
# Source: https://sdkman.io/
#
# Below code is largely based on https://github.com/Comcast/ansible-sdkman ansible role written by Elliot Weiser
---
- name: "[SDKMan] Check for SDKMAN installation"
  stat:
    path: '{{ sdkman_dir }}/bin/sdkman-init.sh'
  register: sdkman_init

# Install SDKMAN if not uninstalled
- block:
    - name: "[SDKMan] Download SDKMAN"
      get_url:
        url: https://get.sdkman.io
        dest: '{{ sdkman_tmp_dir }}/sdkman_script'
        owner: '{{ sdkman_user }}'
        group: '{{ sdkman_group }}'
        validate_certs: '{{ sdkman_validate_ssl }}'

    - name: "[SDKMan] Run SDKMAN script"
      environment:
        SDKMAN_DIR: '{{ sdkman_dir }}'
      command: /bin/bash {{ sdkman_tmp_dir }}/sdkman_script
      args:
        creates: '{{ sdkman_dir }}/bin/sdkman-init.sh'
      notify: "[SDKMan] Cleanup SDKMAN script"

  when: not sdkman_init.stat.exists
  become: '{{ sdkman_user != ansible_user_id }}'
  become_user: '{{ sdkman_user }}'

- name: "[SDKMan] Fix permissions on SDKMAN_DIR"
  file:
    path: '{{ sdkman_dir }}'
    state: directory
    owner: '{{ sdkman_user }}'
    group: '{{ sdkman_group }}'
    recurse: true
  become: yes
  tags:
    - sdkman_privilege

- name: "[SDKMan] Flush SDK caches (before)"
  shell: >-
    . {{ sdkman_dir }}/bin/sdkman-init.sh && sdk flush {{ item }}
  args:
    executable: /bin/bash
  loop: '{{ sdkman_flush_caches_before }}'
  changed_when: false

- name: "[SDKMan] Update SDKMAN"
  shell: . {{ sdkman_dir }}/bin/sdkman-init.sh && sdk selfupdate
  args:
    executable: /bin/bash
  register: sdk_selfupdate
  changed_when: sdk_selfupdate.stdout != 'No update available at this time.'
  when: sdkman_update | bool

- name: "[SDKMan] Install SDK candidates/versions"
  shell: >-
    . {{ sdkman_dir }}/bin/sdkman-init.sh &&
    sdk install {{ item.candidate }} {{ item.version | default('') }} {{ item.localpath | default('') }}
  args:
    executable: /bin/bash
  loop: '{{ sdkman_install_packages }}'
  register: sdk_install
  changed_when: >-
    'is already installed.' not in sdk_install.stdout
  failed_when: >-
    sdk_install.rc != 0 and
    'is already installed.' not in sdk_install.stdout

- name: "[SDKMan] Save installed SDKs versions"
  set_fact:
    used_dev_versions: "{{ used_dev_versions | combine({'sdkman_install_packages': sdkman_install_packages}) }}"

- name: "[SDKMan] Uninstall SDK candidates/versions"
  shell: >-
    . {{ sdkman_dir }}/bin/sdkman-init.sh &&
    sdk uninstall {{ item.candidate }} {{ item.version }}
  args:
    executable: /bin/bash
  loop: '{{ sdkman_uninstall_packages }}'
  register: sdk_uninstall
  changed_when: >-
    not item.candidate + ' ' + item.version + ' is not installed.'
    in sdk_uninstall.stdout

- name: "[SDKMan] Get SDK defaults"
  shell: . {{ sdkman_dir }}/bin/sdkman-init.sh && sdk current {{ item }}
  args:
    executable: /bin/bash
  register: get_sdk_defaults
  changed_when: false
  loop: >-
    {{ sdkman_install_packages | map(attribute="candidate") | unique | list }}

- name: "[SDKMan] Set SDK defaults"
  shell: >-
    . {{ sdkman_dir }}/bin/sdkman-init.sh &&
    sdk default {{ item.key }} {{ item.value }}
  args:
    executable: /bin/bash
  loop: '{{ sdkman_defaults | dict2items }}'
  changed_when: >-
    not item.value in
    (get_sdk_defaults.results |
     selectattr('item', 'equalto', item.key) |
     first).stdout

- name: "[SDKMan] Save default SDKs versions"
  set_fact:
    used_dev_versions: "{{ used_dev_versions | combine({'sdkman_defaults': sdkman_defaults}) }}"

- name: "[SDKMan] Flush SDK caches (after)"
  shell: . {{ sdkman_dir }}/bin/sdkman-init.sh && sdk flush {{ item }}
  args:
    executable: /bin/bash
  loop: '{{ sdkman_flush_caches_after }}'
  changed_when: false

- name: "[SDKMan] Update alternatives"
  alternatives:
    name: "{{ item.name }}"
    path: "{{ sdkman_dir }}/candidates/{{ item.candidate }}/current/bin/{{ item.name }}"
    link: "{{ item.link }}"
  loop: "{{ sdkman_update_alternatives }}"
  become: yes
  tags:
    - sdkman_privilege